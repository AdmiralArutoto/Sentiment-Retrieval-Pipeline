<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Sentiment RAG Retrieval</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        color-scheme: light dark;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        line-height: 1.5;
      }
      body {
        margin: 0;
        background: #f4f7fb;
        color: #1e1e1e;
      }
      .page {
        max-width: 920px;
        margin: 0 auto;
        padding: 2rem 1rem 4rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }
      header h1 {
        margin-bottom: 0.5rem;
      }
      .panel {
        background: #ffffff;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 8px 24px rgba(15, 23, 42, 0.12);
      }
      form {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }
      textarea,
      input {
        font: inherit;
        padding: 0.75rem;
        border-radius: 8px;
        border: 1px solid #cbd5f5;
        resize: vertical;
      }
      .controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 0.75rem;
      }
      .control-group {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
      }
      button {
        font: inherit;
        padding: 0.85rem 1rem;
        border-radius: 8px;
        border: none;
        background: #2563eb;
        color: #fff;
        cursor: pointer;
        transition: background 0.2s ease;
      }
      button:disabled {
        background: #94a3b8;
        cursor: not-allowed;
      }
      .status {
        min-height: 1.5rem;
        margin-top: 0.75rem;
        font-size: 0.95rem;
        color: #475569;
      }
      .results h2 {
        margin-top: 0;
      }
      .result-card {
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        background: #f8fafc;
      }
      .answer-card {
        border: 1px solid #c7d2fe;
        background: #eef2ff;
        border-radius: 10px;
        padding: 1rem;
        font-size: 1rem;
        white-space: pre-wrap;
      }
      .result-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        font-size: 0.85rem;
        color: #475569;
      }
      .meta-pill {
        background: #e0e7ff;
        padding: 0.2rem 0.6rem;
        border-radius: 999px;
      }
      .result-card pre {
        white-space: pre-wrap;
        word-break: break-word;
        margin: 0.5rem 0 0;
        font-size: 0.95rem;
      }
    </style>
  </head>
  <body>
    <main class="page">
      <header>
        <h1>Sentiment Retrieval</h1>
        <p>
          Ask about user opinions (e.g., positive travel experiences, negative product feedback)
          and our retriever will output relevant context chunks from our dataset.
        </p>
      </header>

      <section class="panel">
        <form id="query-form">
          <label for="query">User query</label>
          <textarea
            id="query"
            name="query"
            rows="3"
            placeholder="What are people saying about customer support?"
            required
          ></textarea>

          <div class="controls">
            <div class="control-group">
              <label for="top-k">Top-K</label>
              <input id="top-k" name="top-k" type="number" min="1" max="10" value="4" />
            </div>

            <div class="control-group">
              <label for="min-score">Min score</label>
              <input
                id="min-score"
                name="min-score"
                type="number"
                min="0"
                max="1"
                step="0.01"
                value="0.62"
              />
            </div>

            <div class="control-group">
              <label for="max-output-tokens">Max output tokens</label>
              <input
                id="max-output-tokens"
                name="max-output-tokens"
                type="number"
                min="32"
                max="2048"
                step="16"
                value="256"
              />
            </div>
          </div>

          <button type="submit">Retrieve + Generate</button>
        </form>
        <div id="status" class="status"></div>
      </section>

      <section class="panel results" aria-live="polite">
        <h2>Generated answer</h2>
        <div id="answer" class="answer-card">Answer will appear here.</div>
      </section>

      <section class="panel results" aria-live="polite">
        <h2>Supporting chunks</h2>
        <div id="results"></div>
      </section>
    </main>

    <script>
      const form = document.getElementById("query-form");
      const queryInput = document.getElementById("query");
      const topKInput = document.getElementById("top-k");
      const minScoreInput = document.getElementById("min-score");
      const maxTokensInput = document.getElementById("max-output-tokens");
      const resultsContainer = document.getElementById("results");
      const statusEl = document.getElementById("status");
      const answerEl = document.getElementById("answer");

      const setStatus = (message, isError = false) => {
        statusEl.textContent = message;
        statusEl.style.color = isError ? "#b91c1c" : "#475569";
      };

      const applyConfigDefaults = (config) => {
        if (config?.default_top_k !== undefined) topKInput.value = config.default_top_k;
        if (config?.default_min_score !== undefined) minScoreInput.value = config.default_min_score;
        if (config?.default_max_output_tokens !== undefined)
          maxTokensInput.value = config.default_max_output_tokens;
        if (config?.embedding_model) {
          setStatus(`Using embedding model ${config.embedding_model} and generation model ${config.generation_model}.`);
        }
      };

      const loadConfigDefaults = async () => {
        try {
          const response = await fetch("/config");
          if (!response.ok) return;
          const config = await response.json();
          applyConfigDefaults(config);
        } catch (error) {
          console.warn("Could not load server defaults", error);
        }
      };

      const renderAnswer = (answer) => {
        answerEl.textContent = answer || "No answer generated from the available context.";
      };

      const renderResults = (results) => {
        resultsContainer.innerHTML = "";
        if (!results.length) {
          resultsContainer.innerHTML = "<p>No supporting chunks met the similarity threshold.</p>";
          return;
        }

        results.forEach((result, index) => {
          const wrapper = document.createElement("article");
          wrapper.className = "result-card";
          wrapper.innerHTML = `
            <div class="result-meta">
              <span class="meta-pill">#${index + 1}</span>
              <span class="meta-pill">${result.chunk_id}</span>
              <span class="meta-pill">Chunk ${result.metadata.chunk_index}</span>
              <span class="meta-pill">Score: ${result.score}</span>
              <span class="meta-pill">Sentiment: ${result.metadata.sentiment}</span>
              <span class="meta-pill">Source: ${result.metadata.source}</span>
            </div>
            <pre>${result.text}</pre>
            <p class="result-meta">
              User ${result.metadata.user_id} • ${result.metadata.location} • ${result.metadata.date}
            </p>
          `;
          resultsContainer.appendChild(wrapper);
        });
      };

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        const query = queryInput.value.trim();
        const topK = Number(topKInput.value) || 4;
        const minScore = Number(minScoreInput.value) || 0.62;
        const maxTokens = Number(maxTokensInput.value) || 256;

        if (!query) {
          setStatus("Please enter a query.", true);
          return;
        }

        const submitButton = form.querySelector("button");
        submitButton.disabled = true;
        setStatus("Retrieving context and generating answer...");

        try {
          const response = await fetch("/generate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              query,
              top_k: topK,
              min_score: minScore,
              max_output_tokens: maxTokens,
            }),
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail ?? "Unknown error");
          }

          const payload = await response.json();
          renderAnswer(payload.answer);
          renderResults(payload.citations || []);
          setStatus(`Generated answer with ${payload.citations?.length ?? 0} supporting chunk(s).`);
        } catch (error) {
          console.error(error);
          setStatus(error.message || "Something went wrong.", true);
        } finally {
          submitButton.disabled = false;
        }
      });

      loadConfigDefaults();
    </script>
  </body>
</html>
